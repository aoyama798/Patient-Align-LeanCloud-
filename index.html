<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>创二病人看板系统</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* ===== 顶部容器（header + input） ===== */
.top-container {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 各占 50% */
  align-items: stretch;
  gap: 1rem;
  padding: 1rem;
  box-sizing: border-box;
}

/* ===== header 样式 ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background: linear-gradient(90deg, #64b5f6, #2196f3);
  color: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

/* 左侧 logo 与标题 */
header .left {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

header img {
  height: 3rem;
}

header h1 {
  margin: 0;
  font-size: 1.4rem;
  letter-spacing: 1px;
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

/* “创二”在上，“患者看板”在下 */
header h1 span:first-child {
  font-size: 1.1rem;
  font-weight: bold;
}
header h1 span:last-child {
  font-size: 1rem;
  opacity: 0.9;
}

/* 右侧按钮 */
header .right {
  display: flex;
  gap: 0.6rem;
}
header button {
  background: rgba(255,255,255,0.2);
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-size: 0.95rem;
  transition: 0.2s;
}
header button:hover {
  background: rgba(255,255,255,0.35);
}

/* ===== 输入区 ===== */
.input-area {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.6rem;
  padding: 1rem 2rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  box-sizing: border-box;
}

/* 输入框 */
.input-area input {
  flex: 1;
  min-width: 0;
  padding: 0.6rem 1rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
  box-sizing: border-box;
}

/* 按钮 */
.input-area button {
  flex-shrink: 0;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  border: none;
  background: #2196F3;
  color: white;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.2s;
  white-space: nowrap;
}
.input-area button:hover {
  background: #1976D2;
}

/* ===== 响应式：小屏时垂直排列 ===== */
@media (max-width: 800px) {
  .top-container {
    grid-template-columns: 1fr; /* 垂直排列 */
  }
  .input-area {
    flex-direction: column;
    align-items: stretch;
  }
  .input-area input,
  .input-area button {
    width: 100%;
  }
  header {
  padding: 0.8rem 0.5rem;
  }

}
  
/* ===== 看板主体 Grid ===== */
.board {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  align-items: stretch; /* 让医生列高度统一 */
  gap: 1rem;
  padding: 0 2rem 2rem;
}

/* ===== 医生列 ===== */
.doctor-column {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  min-height: 320px;
}

.doctor-column h2 {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.1rem;
  color: #333;
  margin-bottom: 1rem;
}

.doctor-column h2 i {
  margin-left: 0.4rem;
  cursor: pointer;
  color: #777;
  transition: 0.2s;
}
.doctor-column h2 i:hover { color: #2196F3; }

/* ===== 病人卡片 ===== */
.patient-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  padding: 0.8rem 1rem;
  border-radius: 10px;
  margin-bottom: 0.6rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.patient-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.patient-card.recent {
  border: 2px solid #f44336;
}

.patient-name {
  font-size: 1rem;
  font-weight: 600;
  color: #333;
}
.patient-note {
  font-size: 0.85rem;
  color: #555;
  margin-top: 0.2rem;
  white-space: pre-wrap;
}

/* ===== 出院/删除区 ===== */
.operation-area {
  display: flex;
  gap: 1rem;
  padding: 1rem 2rem 2rem;
}
.drop-zone {
  flex: 1;
  height: 80px;
  background: white;
  border: 2px dashed #ccc;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  color: #555;
  transition: 0.2s;
}
.drop-zone:hover {
  background: rgba(33,150,243,0.1);
  border-color: #2196F3;
}

/* ===== 模态框 ===== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}
.modal-buttons button {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}
#modalConfirm, #modalConfirmDoctor { background:#2196F3; color:#fff; }
#modalDelete, #modalDeleteDoctor { background:#f44336; color:#fff; }
#modalDischarge { background:#4CAF50; color:#fff; }
#modalCancel, #modalCancelDoctor { background:#aaa; color:#fff; }
</style>
</head>





  
<body>
<div class="top-container">
  <!-- ===== 左侧 header ===== -->
  <header>
    <div class="left">
      <img src="https://mac-upic.oss-cn-chengdu.aliyuncs.com/logo.png" alt="logo">
      <h1>
        <span>创二</span>
        <span>患者看板</span>
      </h1>
    </div>
    <div class="right">
      <button id="currentPatientsBtn"><i class="bi bi-house"></i> 在院</button>
      <button id="allPatientsBtn"><i class="bi bi-people"></i> 所有</button>
    </div>
  </header>

  <!-- ===== 右侧 输入区 ===== -->
  <section class="input-area">
    <input type="text" id="patientName" placeholder="输入病人姓名">
    <input list="doctorList" id="doctorInput" placeholder="输入医生或选择">
    <datalist id="doctorList"></datalist>
    <button id="addPatientBtn"><i class="bi bi-person-plus"></i> 新增病人</button>
  </section>
</div>

  
<section class="board">
  <div class="doctor-columns" id="doctorColumns"></div>
</section>

<section class="operation-area">
  <div class="drop-zone" id="dischargeZone"><i class="bi bi-box-arrow-up"></i> 出院</div>
  <div class="drop-zone" id="deleteZone"><i class="bi bi-trash"></i> 删除</div>
</section>
  
<a href="https://aoyama798.github.io/blog2/" style="text-decoration: none; color: inherit;">
  <div style="text-align: center; margin: 18px;">©Aoyama798</div>
</a>

<!-- 病人编辑模态 -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>编辑病人</h3>
    <span>姓名</span><input type="text" id="modalInput" placeholder="姓名">
    <span>备注</span><textarea id="modalNotes" placeholder="备注/代办事项"></textarea>
    <span>分配医生</span><select id="modalDoctorSelect"></select>
    <div class="modal-buttons">
      <button id="modalDischarge"><i class="bi bi-box-arrow-up"></i> 出院</button>
      <button id="modalDelete"><i class="bi bi-trash"></i> 删除</button>
      <button id="modalConfirm"><i class="bi bi-check-circle"></i> 确认</button>
      <button id="modalCancel"><i class="bi bi-x-circle"></i> 取消</button>
    </div>
  </div>
</div>

<!-- 医生编辑模态 -->
<div class="modal" id="editDoctorModal">
  <div class="modal-content">
    <h3>编辑医生</h3>
    <span>医生姓名</span><input type="text" id="modalDoctorName" placeholder="医生姓名">
    <span>展示顺序</span><input type="text" id="modalDoctorOrderText" placeholder="用-分隔医生顺序，例如：肖-汪-曹">
    <div class="modal-buttons">
      <button id="modalDeleteDoctor"><i class="bi bi-trash"></i> 删除医生及其病人</button>
      <button id="modalConfirmDoctor"><i class="bi bi-check-circle"></i> 确认</button>
      <button id="modalCancelDoctor"><i class="bi bi-x-circle"></i> 取消</button>
    </div>
  </div>
</div>







  
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script>
<script>
// ===== LeanCloud 初始化 =====
AV.init({
  appId: "aMqT7BEEzEAg4xdPE7YrniuN-gzGzoHsz",
  appKey: "hWHxbIukqYqAVGJh839mj32y",
  serverURL: "https://amqt7bee.lc-cn-n1-shared.com"
});

// ===== 数据 =====
let patients = [];
let doctorOrder = [];
let recentPatientName = "";
let currentView = "current"; // current / all

const doctorColumns = document.getElementById("doctorColumns");
const doctorInput = document.getElementById("doctorInput");
const doctorList = document.getElementById("doctorList");
const patientNameInput = document.getElementById("patientName");
const addPatientBtn = document.getElementById("addPatientBtn");

const editModal = document.getElementById("editModal");
const modalInput = document.getElementById("modalInput");
const modalNotes = document.getElementById("modalNotes");
const modalDoctorSelect = document.getElementById("modalDoctorSelect");
const modalConfirm = document.getElementById("modalConfirm");
const modalCancel = document.getElementById("modalCancel");
const modalDischarge = document.getElementById("modalDischarge");
const modalDelete = document.getElementById("modalDelete");

const dischargeZone = document.getElementById("dischargeZone");
const deleteZone = document.getElementById("deleteZone");

const currentPatientsBtn = document.getElementById("currentPatientsBtn");
const allPatientsBtn = document.getElementById("allPatientsBtn");

// 医生模态元素
const editDoctorModal = document.getElementById("editDoctorModal");
const modalDoctorName = document.getElementById("modalDoctorName");
const modalDoctorOrderText = document.getElementById("modalDoctorOrderText");
const modalDeleteDoctor = document.getElementById("modalDeleteDoctor");
const modalConfirmDoctor = document.getElementById("modalConfirmDoctor");
const modalCancelDoctor = document.getElementById("modalCancelDoctor");

let currentEdit = null;
let currentEditDoctorIndex = null;

// ===== 渲染医生列和病人 =====
function renderBoard() {
  doctorColumns.innerHTML = "";
  doctorColumns.style.display = "grid";
  doctorColumns.style.gridTemplateColumns = "1fr 1fr"; 
  doctorColumns.style.gap = "1rem";
  doctorColumns.style.alignItems = "start"; 
  doctorColumns.style.justifyItems = "stretch"; 

  doctorOrder.forEach((doc, idx) => {
    const col = document.createElement("div");
    col.className = "doctor-column";

    const h2 = document.createElement("h2");
    h2.textContent = doc;
    col.appendChild(h2);
    h2.addEventListener("click", () => openDoctorModal(idx));

    patients.filter(p => p.doctor === doc).forEach(p => {
      if (currentView === "current" && p.discharged) return;

      const card = document.createElement("div");
      card.className = "patient-card";
      if (p.name === recentPatientName) card.classList.add("recent");
      card.draggable = true;

      card.addEventListener("dragstart", e => { e.dataTransfer.setData("text/plain", p.objectId); });
      card.addEventListener("click", () => openEditModal(p));

      const nameSpan = document.createElement("span");
      nameSpan.textContent = currentView === "all" && p.discharged ? `${p.name}（已出院）` : p.name;
      card.appendChild(nameSpan);

      if (p.notes && p.notes.trim() !== "") {
        const noteDiv = document.createElement("div");
        noteDiv.textContent = p.notes;
        noteDiv.style.fontSize = "0.85rem";
        noteDiv.style.color = "#555";
        noteDiv.style.marginTop = "0.3rem";
        card.appendChild(noteDiv);
      }

      col.appendChild(card);
    });

    col.style.flex = "unset";
    col.style.minWidth = "0";
    doctorColumns.appendChild(col);
  });

  updateDoctorDatalist();
}

// ===== 更新 datalist =====
function updateDoctorDatalist(){
  doctorList.innerHTML = "";
  doctorOrder.forEach(d=>{
    const option = document.createElement("option");
    option.value = d;
    doctorList.appendChild(option);
  });
}

// ===== 模态框交互 =====
function openEditModal(patient){
  currentEdit = patient;
  modalInput.value = patient.name;
  modalNotes.value = patient.notes;

  modalDoctorSelect.innerHTML = "";
  doctorOrder.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    if(d===patient.doctor) opt.selected = true;
    modalDoctorSelect.appendChild(opt);
  });

  editModal.style.display = "flex";
}

modalConfirm.addEventListener("click", ()=>{
  if(currentEdit){
    currentEdit.name = modalInput.value.trim();
    currentEdit.notes = modalNotes.value;
    currentEdit.doctor = modalDoctorSelect.value;
    renderBoard();
    updatePatientInCloud(currentEdit);
    editModal.style.display = "none";
  }
});

modalCancel.addEventListener("click", ()=>{ editModal.style.display = "none"; });

// ===== 二级确认模态框 =====
const confirmModal = document.createElement('div');
confirmModal.className = 'modal';
confirmModal.id = 'confirmModal';
confirmModal.innerHTML = `
  <div class="modal-content">
    <h3 id="confirmTitle">确认操作</h3>
    <p id="confirmMessage"></p>
    <div class="modal-buttons">
      <button id="confirmYes" style="background:#f44336;color:#fff;">确认</button>
      <button id="confirmNo" style="background:#aaa;color:#fff;">取消</button>
    </div>
  </div>
`;
document.body.appendChild(confirmModal);

let confirmCallback = null;
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const confirmMessage = document.getElementById('confirmMessage');

function openConfirmModal(message, callback){
  confirmMessage.textContent = message;
  confirmModal.style.display = 'flex';
  confirmCallback = callback;
}

confirmYes.addEventListener('click', ()=>{
  if(confirmCallback) confirmCallback();
  confirmModal.style.display = 'none';
  confirmCallback = null;
});

confirmNo.addEventListener('click', ()=>{
  confirmModal.style.display = 'none';
  confirmCallback = null;
});

// ===== 出院/删除事件 =====
modalDischarge.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(!currentEdit) return;
  openConfirmModal(`确认将病人 ${currentEdit.name} 出院吗？`, ()=>{
    currentEdit.discharged = true;
    updatePatientInCloud(currentEdit);
    renderBoard();
    editModal.style.display = 'none';
  });
});

modalDelete.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(!currentEdit) return;
  openConfirmModal(`确认删除病人 ${currentEdit.name} 吗？`, ()=>{
    deletePatientInCloud(currentEdit);
    patients = patients.filter(p=>p.objectId!==currentEdit.objectId);
    renderBoard();
    editModal.style.display = 'none';
  });
});

// ===== 拖拽出院/删除 =====
[dischargeZone, deleteZone].forEach(zone=>{
  zone.addEventListener("dragover", e=>e.preventDefault());
  zone.addEventListener("drop", e=>{
    e.preventDefault();
    const objectId = e.dataTransfer.getData("text/plain");
    const patient = patients.find(p=>p.objectId===objectId);
    if(!patient) return;

    if(zone.id==="dischargeZone"){
      openConfirmModal(`确认将病人 ${patient.name} 出院吗？`, ()=>{
        patient.discharged = true;
        updatePatientInCloud(patient);
        renderBoard();
      });
    } else {
      openConfirmModal(`确认删除病人 ${patient.name} 吗？`, ()=>{
        deletePatientInCloud(patient);
        patients = patients.filter(p=>p.objectId!==objectId);
        renderBoard();
      });
    }
  });
});

// ===== 医生模态 =====
function openDoctorModal(idx){
  currentEditDoctorIndex = idx;
  modalDoctorName.value = doctorOrder[idx];
  modalDoctorOrderText.value = doctorOrder.join("-");
  editDoctorModal.style.display = "flex";
}

modalConfirmDoctor.addEventListener("click", ()=>{
  if(currentEditDoctorIndex === null) return;
  const oldName = doctorOrder[currentEditDoctorIndex];
  const newName = modalDoctorName.value.trim();
  if(!newName) return alert("医生姓名不能为空");

  doctorOrder[currentEditDoctorIndex] = newName;
  patients.forEach(p=>{
    if(p.doctor===oldName) { p.doctor=newName; updatePatientInCloud(p); }
  });

  const newOrderStr = modalDoctorOrderText.value.trim();
  if(newOrderStr){
    doctorOrder = newOrderStr.split("-").map(s=>s.trim()).filter(Boolean);
  }

  syncDoctorCloud();
  renderBoard();
  editDoctorModal.style.display="none";
});

modalDeleteDoctor.addEventListener("click", ()=>{
  if(currentEditDoctorIndex === null) return;
  const nameToDelete = doctorOrder[currentEditDoctorIndex];
  if(!confirm(`确认删除医生 ${nameToDelete} 及其所有病人吗？`)) return;

  const patientsToDelete = patients.filter(p=>p.doctor===nameToDelete);
  patientsToDelete.forEach(p=>deletePatientInCloud(p));
  patients = patients.filter(p=>p.doctor!==nameToDelete);

  doctorOrder.splice(currentEditDoctorIndex,1);
  syncDoctorCloud();
  renderBoard();
  editDoctorModal.style.display="none";
});

modalCancelDoctor.addEventListener("click", ()=>{ editDoctorModal.style.display="none"; });

// ===== 新增病人 =====
addPatientBtn.addEventListener("click", () => {
  const name = patientNameInput.value.trim();
  let doctor = doctorInput.value.trim();
  if(!name || !doctor) return alert("请输入完整信息");

  if(!doctorOrder.includes(doctor)){
    doctorOrder.push(doctor);
    updateDoctorDatalist();
    syncDoctorCloud();
  }

  const Patient = AV.Object.extend('patients');
  const pObj = new Patient();
  pObj.set('name', name);
  pObj.set('doctor', doctor);
  pObj.set('notes', "");
  pObj.set('discharged', false);
  const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true);
  pObj.setACL(acl);
  pObj.save().then(saved=>{
    const patient = { objectId: saved.id, name, doctor, notes:"", discharged:false };
    patients.push(patient);
    recentPatientName = name;
    renderBoard();
    saveRecentPatientToCloud();
  }).catch(console.error);

  patientNameInput.value = "";
  doctorInput.value = "";
});

// ===== LeanCloud 操作函数 =====
function updatePatientInCloud(patient){
  const query = new AV.Query('patients');
  query.get(patient.objectId).then(obj=>{
    obj.set('name', patient.name);
    obj.set('doctor', patient.doctor);
    obj.set('notes', patient.notes);
    obj.set('discharged', patient.discharged);
    return obj.save();
  }).catch(console.error);
}

function deletePatientInCloud(patient){
  const query = new AV.Query('patients');
  query.get(patient.objectId).then(obj=>obj.destroy()).catch(console.error);
}

function saveRecentPatientToCloud(){
  const Recent = AV.Object.extend('recentPatientName');
  const recentObj = new Recent();
  recentObj.set('name', recentPatientName);
  const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true);
  recentObj.setACL(acl);
  recentObj.save().catch(console.error);
}

// ===== 视图切换 =====
currentPatientsBtn.addEventListener("click", ()=>{currentView="current"; renderBoard();});
allPatientsBtn.addEventListener("click", ()=>{currentView="all"; renderBoard();});

// ===== 数据加载 =====
function loadDoctorsFromCloud(){
  const query = new AV.Query('doctorsOrder');
  return query.first().then(obj=>{
    if(obj){
      doctorOrder = obj.get('name').split("-").map(s=>s.trim()).filter(Boolean);
    } else {
      doctorOrder = [];
    }
  });
}

function loadPatientsFromCloud(){
  const query = new AV.Query('patients');
  return query.find().then(results=>{
    patients = results.map(r=>({
      objectId: r.id,
      name: r.get('name'),
      doctor: r.get('doctor'),
      notes: r.get('notes'),
      discharged: r.get('discharged')
    }));
  });
}

// ===== 医生云端同步 =====
function syncDoctorCloud(){
  const query = new AV.Query('doctorsOrder');
  query.first().then(obj=>{
    let orderObj = obj || new AV.Object('doctorsOrder');
    orderObj.set('name', doctorOrder.join("-"));
    const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true);
    orderObj.setACL(acl);
    return orderObj.save();
  }).catch(console.error);
}

// ===== 初始化 =====
function init(){
  loadDoctorsFromCloud()
    .then(loadPatientsFromCloud)
    .then(renderBoard)
    .catch(console.error);
}
init();
</script>

</body>
</html>
