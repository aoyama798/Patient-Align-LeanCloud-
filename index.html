<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>创二病人看板系统</title>
<style>
body {font-family:"Tahoma",sans-serif;margin:0;padding:0;background:#f4f6f8}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#2196F3;color:#fff}
.input-area{display:flex;gap:.5rem;padding:1rem;flex-wrap:wrap}
/* 替换原来的 .board 样式 */
.board {
  display: flex;
  flex-wrap: wrap;         /* 自动换行 */
  gap: 1rem;               /* 列间距 */
  justify-content: center;  /* 居中排列 */
  padding: 1rem;
}

/* 每列医生 */
.doctor-column {
  background: #fff;
  margin: 0.5rem;
  padding: 0.5rem;
  border-radius: 8px;
  min-width: 200px;
  flex: 1 1 calc(50% - 1rem); /* 两列布局，间距考虑1rem */
  box-sizing: border-box;
}

/* 手机小屏：单列 */
@media (max-width: 600px) {
  .doctor-column {
    flex: 1 1 100%; /* 单列 */
  }
}

/* 平板中屏：两列 */
@media (min-width: 601px) and (max-width: 900px) {
  .doctor-column {
    flex: 1 1 calc(50% - 1rem); /* 两列 */
  }
}

/* 大屏多列自适应 */
@media (min-width: 901px) {
  .doctor-column {
    flex: 1 1 calc(33.33% - 1rem); /* 三列，可根据需要调整 */
  }
}

.doctor-column{background:#fff;margin:.5rem;padding:.5rem;border-radius:8px;min-width:200px;flex-shrink:0}
.doctor-column h2{text-align:center;cursor:pointer}
.patient-card{background:#e3f2fd;margin:.5rem 0;padding:.5rem;border-radius:6px;cursor:grab}
.patient-card.recent{border:2px solid red}
.operation-area{display:flex;gap:1rem;padding:1rem}
.drop-zone{flex:1;height:80px;background:#eee;border:2px dashed #ccc;display:flex;justify-content:center;align-items:center;border-radius:8px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
.modal-content{background:#fff;padding:1rem;border-radius:8px;max-width:400px;width:90%;display:flex;flex-direction:column;gap:.5rem}
textarea{resize:none}
.modal-buttons{display:flex;justify-content:flex-end;gap:.5rem}
@media(max-width:1024px){.board{flex-wrap:wrap}.doctor-column{flex:1 1 45%}}
@media(max-width:600px){.doctor-column{flex:1 1 100%}}
</style>

  
</head>
<body>
<header>
  <h1>创二病人看板系统</h1>
  <div class="view-toggle">
    <button id="currentPatientsBtn">当前在院</button>
    <button id="allPatientsBtn">所有病人</button>
  </div>
</header>

<section class="input-area">
  <input type="text" id="patientName" placeholder="输入病人姓名">
  <input list="doctorList" id="doctorInput" placeholder="输入医生姓名或选择">
  <datalist id="doctorList"></datalist>
  <button id="addPatientBtn">新增病人</button>
</section>

<section class="board">
  <div class="doctor-columns" id="doctorColumns"></div>
</section>

<section class="operation-area">
  <div class="drop-zone" id="dischargeZone">出院</div>
  <div class="drop-zone" id="deleteZone">删除</div>
</section>

<div class="modal" id="editModal">
  <div class="modal-content">
    <h3 id="modalTitle">编辑信息</h3>
    <input type="text" id="modalInput" placeholder="">
    <textarea id="modalNotes" placeholder="备注/代办事项"></textarea>
    <div class="modal-buttons">
      <button id="modalDischarge">出院</button>
      <button id="modalDelete">删除</button>
      <button id="modalConfirm">确认</button>
      <button id="modalCancel">取消</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script>
<script>
// ===== LeanCloud 初始化 =====
AV.init({
  appId: "aMqT7BEEzEAg4xdPE7YrniuN-gzGzoHsz",
  appKey: "hWHxbIukqYqAVGJh839mj32y",
  serverURL: "https://amqt7bee.lc-cn-n1-shared.com"
});

// ===== 数据 =====
let patients = [];
let doctorOrder = ["汪","曹","肖"];
let recentPatientName = "";
let currentView = "current"; // current / all

const doctorColumns = document.getElementById("doctorColumns");
const doctorInput = document.getElementById("doctorInput");
const doctorList = document.getElementById("doctorList");
const patientNameInput = document.getElementById("patientName");
const addPatientBtn = document.getElementById("addPatientBtn");

const editModal = document.getElementById("editModal");
const modalInput = document.getElementById("modalInput");
const modalNotes = document.getElementById("modalNotes");
const modalConfirm = document.getElementById("modalConfirm");
const modalCancel = document.getElementById("modalCancel");
const modalDischarge = document.getElementById("modalDischarge");
const modalDelete = document.getElementById("modalDelete");

const dischargeZone = document.getElementById("dischargeZone");
const deleteZone = document.getElementById("deleteZone");

const currentPatientsBtn = document.getElementById("currentPatientsBtn");
const allPatientsBtn = document.getElementById("allPatientsBtn");

let currentEdit = null;

// ===== 渲染医生列和病人 =====
function renderBoard(){
  doctorColumns.innerHTML = "";
  doctorOrder.forEach((doc, idx) => {
    const col = document.createElement("div");
    col.className = "doctor-column";

    const h2 = document.createElement("h2");
    h2.textContent = doc;
    h2.addEventListener("click", ()=>{
      const newName = prompt("修改医生名字", doc);
      if(newName && newName.trim() && newName !== doc){
        const oldName = doctorOrder[idx];
        doctorOrder[idx] = newName.trim();
        patients.forEach(p=>{ if(p.doctor===oldName) p.doctor=newName.trim(); updatePatientInCloud(p); });
        renderBoard();
      }
    });

    col.appendChild(h2);

    patients.filter(p=>p.doctor===doc).forEach(p=>{
  if(currentView==="current" && p.discharged) return; // 仅显示当前在院
  const card = document.createElement("div");
  card.className = "patient-card";
  if(p.name===recentPatientName) card.classList.add("recent");

  // ===== 新增部分 =====
  if(currentView==="all" && p.discharged){
    card.textContent = `${p.name}（已出院）`;
    card.style.color = "orange"; // 黄色
  } else {
    card.textContent = p.name;
  }
  // =================

  card.draggable = true;
  card.addEventListener("dragstart", e => { e.dataTransfer.setData("text/plain", p.id); });
  card.addEventListener("dblclick", ()=>openEditModal(p));

  col.appendChild(card);
});


    doctorColumns.appendChild(col);
  });

  // 更新 datalist
  doctorList.innerHTML = "";
  doctorOrder.forEach(d=>{
    const option = document.createElement("option");
    option.value = d;
    doctorList.appendChild(option);
  });
}

// ===== 模态框 =====
function openEditModal(patient){
  currentEdit = patient;
  modalInput.value = patient.name;
  modalNotes.value = patient.notes;
  editModal.style.display = "flex";
}

modalConfirm.addEventListener("click", ()=>{
  if(currentEdit){
    currentEdit.name = modalInput.value.trim();
    currentEdit.notes = modalNotes.value;
    renderBoard();
    updatePatientInCloud(currentEdit);
    editModal.style.display = "none";
  }
});

modalCancel.addEventListener("click", ()=>{ editModal.style.display = "none"; });

modalDischarge.addEventListener("click", ()=>{
  if(currentEdit){
    currentEdit.discharged = true;
    updatePatientInCloud(currentEdit);
    renderBoard();
    editModal.style.display = "none";
  }
});

modalDelete.addEventListener("click", ()=>{
  if(currentEdit){
    const query = new AV.Query('patients');
    query.equalTo('id', currentEdit.id);
    query.first().then(obj=>{
      if(obj) return obj.destroy();
    }).then(()=>{
      patients = patients.filter(p=>p.id!==currentEdit.id);
      renderBoard();
      editModal.style.display = "none";
    }).catch(err=>console.error(err));
  }
});

// ===== 新增病人 =====
addPatientBtn.addEventListener("click", () => {
  const name = patientNameInput.value.trim();
  let doctor = doctorInput.value.trim();
  if(!name || !doctor) return alert("请输入完整信息");

  if(!doctorOrder.includes(doctor)) doctorOrder.push(doctor);

  const patient = { name, doctor, notes:"", discharged:false, id:Date.now() };
  patients.push(patient);
  recentPatientName = name;
  renderBoard();
  savePatientToCloud(patient);
  saveRecentPatientToCloud();
  patientNameInput.value = "";
  doctorInput.value = "";
});

// ===== LeanCloud 保存 =====
function savePatientToCloud(patient){
  const Patient = AV.Object.extend('patients');
  const p = new Patient();
  p.set('name', patient.name);
  p.set('doctor', patient.doctor);
  p.set('notes', patient.notes);
  p.set('discharged', patient.discharged);
  p.set('id', patient.id);

  // 设置 ACL，允许公开读写
  const acl = new AV.ACL();
  acl.setPublicReadAccess(true);
  acl.setPublicWriteAccess(true);
  p.setACL(acl);

  p.save().then(()=>console.log('病人已保存到云端'))
           .catch(err=>console.error('保存失败',err));
}

function updatePatientInCloud(patient){
  const query = new AV.Query('patients');
  query.equalTo('id', patient.id);
  query.first().then(obj=>{
    if(obj){
      obj.set('name', patient.name);
      obj.set('doctor', patient.doctor);
      obj.set('notes', patient.notes);
      obj.set('discharged', patient.discharged);
      return obj.save();
    }
  }).then(()=>console.log('病人更新成功'))
    .catch(err=>console.error('更新失败',err));
}

function saveRecentPatientToCloud(){
  const Recent = AV.Object.extend('recentPatientName');
  const recentObj = new Recent();
  recentObj.set('name', recentPatientName);
  const acl = new AV.ACL();
  acl.setPublicReadAccess(true);
  acl.setPublicWriteAccess(true);
  recentObj.setACL(acl);
  recentObj.save().then(()=>console.log('最近病人保存成功'))
                   .catch(err=>console.error('保存最近病人失败',err));
}

// ===== 拖拽出院/删除区 =====
[dischargeZone, deleteZone].forEach(zone=>{
  zone.addEventListener("dragover", e=>e.preventDefault());
  zone.addEventListener("drop", e=>{
    e.preventDefault();
    const id = parseInt(e.dataTransfer.getData("text/plain"));
    const patient = patients.find(p=>p.id===id);
    if(!patient) return;
    if(zone.id==="dischargeZone"){
      patient.discharged = true;
      updatePatientInCloud(patient);
    } else if(zone.id==="deleteZone"){
      const query = new AV.Query('patients');
      query.equalTo('id', patient.id);
      query.first().then(obj=>obj?obj.destroy():null)
           .catch(err=>console.error(err));
      patients = patients.filter(p=>p.id!==id);
    }
    renderBoard();
  });
});

// ===== 视图切换 =====
currentPatientsBtn.addEventListener("click", ()=>{
  currentView = "current";
  renderBoard();
});
allPatientsBtn.addEventListener("click", ()=>{
  currentView = "all";
  renderBoard();
});

// ===== 加载数据 =====
function loadPatientsFromCloud(){
  const query = new AV.Query('patients');
  query.find().then(results=>{
    patients = results.map(r=>({
      id: r.get('id'),
      name: r.get('name'),
      doctor: r.get('doctor'),
      notes: r.get('notes'),
      discharged: r.get('discharged')
    }));
    renderBoard();
  }).catch(err=>console.error(err));
}

function init(){
  doctorOrder.forEach(d=>{
    const option = document.createElement("option");
    option.value = d;
    doctorList.appendChild(option);
  });
  loadPatientsFromCloud();
}

init();
</script>
</body>
</html>
